<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mobile Zeiterfassung</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;900&display=swap" rel="stylesheet">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.27/jspdf.plugin.autotable.min.js"></script>
    
    <style>
        body {
            font-family: 'Inter', sans-serif;
            touch-action: manipulation;
        }
        .action-btn {
            transition: all 0.2s ease-in-out;
        }
        .action-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
        }
        .status { 
             margin-top: 15px; padding: 16px; border-radius: 12px; text-align: center; font-size: 1.2em; font-weight: 600;
             box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
        }
        .status.working { 
            background-color: #10b98120; color: #10b981; border: 2px solid #059669; 
        }
        .status.paused { 
            background-color: #f59e0b20; color: #f59e0b; border: 2px solid #d97706; 
        }
        .status.stopped { 
            background-color: #ef444420; color: #ef4444; border: 2px solid #b91c1c; 
        }
        .zeit { 
            background-color: #374151; color: #fcd34d; padding: 16px; border-radius: 12px; text-align: center; font-size: 1.5em; font-weight: 700; margin-top: 10px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
        }
        .summary-shift {
            background-color: #374151; padding: 12px; border-radius: 8px; border-left: 4px solid #fcd34d; 
        }
        .current-shift {
            background-color: #1f2937; 
            border: 2px solid #fcd34d; 
            box-shadow: 0 4px 10px rgba(252, 211, 77, 0.3);
            order: -1; 
        }
        .action-btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
            background-color: #4b5563;
        }
        .share-button-container {
             display: flex;
             justify-content: flex-end; 
             margin-bottom: 20px;
        }
        .checkbox-row {
            display: flex;
            justify-content: space-between;
            gap: 10px;
            margin-top: 10px;
        }
        .checkbox-container {
            display: flex;
            align-items: center;
            justify-content: flex-start;
            flex-grow: 1;
        }
        .vacation-control {
            border: 1px solid #3b82f6; 
            background-color: #1f2937;
            padding: 16px;
            border-radius: 8px;
            margin-top: 16px;
            transition: all 0.3s ease-in-out;
            display: none; 
            opacity: 0;
        }
        .vacation-control.active {
            display: block;
            opacity: 1;
        }
    </style>
</head>
<body class="bg-gray-900 text-white min-h-screen flex flex-col items-center p-4 sm:p-6">
    
    <div class="w-full max-w-lg mx-auto">
        
        <header class="text-center mb-6">
            <h1 class="text-4xl font-bold text-yellow-400">‚è±Ô∏è Mobile Zeiterfassung</h1>
            <p class="text-gray-400 mt-2">Ihre Arbeitszeit und Protokoll auf einen Blick.</p>
        </header>

        <div class="bg-gray-800 p-6 rounded-2xl shadow-lg mb-6 space-y-4">
            
            <div>
                <label for="fahrername" class="block text-sm font-medium text-gray-300 mb-1">Fahrer/Mitarbeiter</label>
                <input type="text" id="fahrername" placeholder="Ihr Name" 
                       class="w-full bg-gray-700 border border-gray-600 rounded-lg p-3 text-white focus:ring-2 focus:ring-yellow-400 focus:border-yellow-400 transition">
            </div>

            <div>
                <label for="kennzeichen" class="block text-sm font-medium text-gray-300 mb-1">Fahrzeug (Kennzeichen)</label>
                <select id="kennzeichen" 
                        class="w-full bg-gray-700 border border-gray-600 rounded-lg p-3 text-white focus:ring-2 focus:ring-yellow-400 focus:border-yellow-400 transition appearance-none">
                    <option value="" disabled selected class="text-gray-500">Kennzeichen ausw√§hlen...</option>
                </select>
                
                <div class="checkbox-row">
                    <div class="checkbox-container">
                        <input type="checkbox" id="feiertag-checkbox" class="w-4 h-4 text-yellow-400 bg-gray-700 border-gray-600 rounded focus:ring-yellow-500">
                        <label for="feiertag-checkbox" class="ml-2 text-sm font-medium text-yellow-400 whitespace-nowrap">FEIERTAG</label>
                    </div>
                    
                    <div class="checkbox-container">
                        <input type="checkbox" id="vacation-toggle-checkbox" class="w-4 h-4 text-blue-400 bg-gray-700 border-gray-600 rounded focus:ring-blue-500">
                        <label for="vacation-toggle-checkbox" class="ml-2 text-sm font-medium text-blue-400 whitespace-nowrap">URLAUB</label>
                    </div>
                </div>
                </div>
            
            <div id="vacation-control" class="vacation-control">
                <h3 class="text-lg font-semibold text-blue-400 mb-3">üóìÔ∏è Urlaubszeitraum w√§hlen</h3>
                <div class="flex gap-2 mb-2">
                    <div class="w-1/2">
                        <label for="vacation-date-start" class="block text-xs font-medium text-gray-400">Von (Datum)</label>
                        <input type="date" id="vacation-date-start" class="w-full bg-gray-800 border border-gray-600 rounded-lg p-2 text-white focus:ring-2 focus:ring-blue-400">
                    </div>
                    <div class="w-1/2">
                        <label for="vacation-date-end" class="block text-xs font-medium text-gray-400">Bis (Datum)</label>
                        <input type="date" id="vacation-date-end" class="w-full bg-gray-800 border border-gray-600 rounded-lg p-2 text-white focus:ring-2 focus:ring-blue-400">
                    </div>
                </div>
                 <div class="flex gap-2">
                    <button onclick="saveVacationDays()" class="action-btn w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 rounded-lg text-sm">
                        Urlaub speichern (Werktage abz√ºgl. Feiertage berechnen)
                    </button>
                </div>
                <p id="vacation-info" class="text-xs text-gray-400 mt-2">Aktuell: Keine Urlaubstage definiert.</p>
            </div>
            <div id="status" class="status stopped">Gestoppt</div>
            
            <div id="uhr" class="zeit">00:00:00 (Nettozeit heute)</div>

            <div class="flex justify-between gap-4 pt-2">
                <button id="btnStartStop" onclick="startStopTracking()" 
                        class="action-btn w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 rounded-lg text-lg">
                    Starten / Speichern
                </button>
                <button id="btnPause" onclick="togglePause()" 
                        class="action-btn w-full bg-yellow-500 hover:bg-yellow-600 text-gray-900 font-bold py-3 rounded-lg text-lg" disabled>
                    Pause
                </button>
            </div>
            
            
            <button id="btnMonthSummary" onclick="createMonthSummary()" 
                    class="action-btn w-full bg-red-600 hover:bg-red-700 text-white font-bold py-3 rounded-lg mt-4" disabled>
                Monatsabrechnung [Monatsname] erstellen (PDF)
            </button>
            <p id="summary-info" class="text-sm text-gray-400 text-center mt-2"></p>
            
            
            <button id="btnToggleManual" onclick="toggleManualShiftInput()" 
                    class="action-btn w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 rounded-lg mt-4 text-lg flex items-center justify-center space-x-2">
                <span id="manual-toggle-icon">‚ûï</span>
                <span>Manuelle Schichteingabe (Nachtrag) anzeigen</span>
            </button>

            <div id="manual-shift-container" style="display: none;" class="pt-4 border-t border-gray-700 mt-6 space-y-4">
                <h3 class="text-lg font-semibold text-orange-400">üìÖ Manuelle Schichteingabe</h3>
                
                <div>
                    <label for="manual-date" class="block text-sm font-medium text-gray-300 mb-1">Datum der Schicht</label>
                    <input type="date" id="manual-date" class="w-full bg-gray-700 border border-gray-600 rounded-lg p-3 text-white focus:ring-2 focus:ring-orange-400">
                </div>

                <div class="flex gap-4">
                    <div class="w-1/3">
                        <label for="manual-start" class="block text-sm font-medium text-gray-300 mb-1">Start (hh:mm)</label>
                        <input type="time" id="manual-start" value="08:00" class="w-full bg-gray-700 border border-gray-600 rounded-lg p-3 text-white focus:ring-2 focus:ring-orange-400">
                    </div>
                    <div class="w-1/3">
                        <label for="manual-end" class="block text-sm font-medium text-gray-300 mb-1">Ende (hh:mm)</label>
                        <input type="time" id="manual-end" value="17:00" class="w-full bg-gray-700 border border-gray-600 rounded-lg p-3 text-white focus:ring-2 focus:ring-orange-400">
                    </div>
                    <div class="w-1/3">
                        <label for="manual-pause" class="block text-sm font-medium text-gray-300 mb-1">Pause (Min.)</label>
                        <input type="number" id="manual-pause" value="60" min="0" class="w-full bg-gray-700 border border-gray-600 rounded-lg p-3 text-white focus:ring-2 focus:ring-orange-400">
                    </div>
                </div>
                
                <button onclick="submitManualShift()" 
                        class="action-btn w-full bg-orange-600 hover:bg-orange-700 text-white font-bold py-3 rounded-lg text-lg">
                    Schicht nachtragen & speichern
                </button>
            </div>
            <div class="pt-4 border-t border-gray-700 mt-4 space-y-3" id="archive-section">
                <h3 class="text-lg font-semibold text-yellow-400">Historische Monatsdaten (Archiv)</h3>
                 <div>
                    <select id="archive-select" 
                            class="w-full bg-gray-700 border border-gray-600 rounded-lg p-3 text-white focus:ring-2 focus:ring-yellow-400 focus:border-yellow-400 transition appearance-none">
                        <option value="" disabled selected class="text-gray-500">Abrechnungen ausw√§hlen...</option>
                    </select>
                </div>
                <button id="btnRecreatePdf" onclick="recreatePdfFromArchive()" disabled
                        class="action-btn w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-lg">
                    PDF erneut erstellen
                </button>
            </div>
        </div>
        
        <div class="bg-gray-800 p-6 rounded-2xl shadow-lg mt-8">
            <h2 class="text-2xl font-semibold mb-4 text-yellow-400">Gespeicherte Schichten</h2>
            <div id="shift-summary-list" class="space-y-3 max-h-96 overflow-y-auto pr-2 flex flex-col">
                 <p class="text-gray-400">Noch keine abgeschlossenen Schichten gespeichert.</p>
            </div>
        </div>

        <div class="pt-6 mt-2 space-y-3">
            <button id="btnDeleteAllData" onclick="deleteAllData()" 
                    class="action-btn w-full bg-red-900 hover:bg-red-700 text-white font-black py-3 rounded-lg text-sm uppercase flex items-center justify-center space-x-2">
                <span class="text-xl">‚ö†Ô∏è</span><span>ALLE SCHICHTDATEN L√ñSCHEN</span><span class="text-xl">‚ö†Ô∏è</span>
            </button>
        </div>


    </div>

    <script>
        const { jsPDF } = window.jspdf;

        // ===============================================
        // ‚öôÔ∏è TESTMODUS DEAKTIVIERT 
        // ===============================================
        const TEST_MODE = false; 
        // ===============================================
        
        
        // --- LocalStorage Keys ---
        const NAME_KEY = 'fahrername';           
        const SHIFTS_KEY = 'zeitlog_shifts';     
        const STATE_KEY = 'timer_state';         
        const KENNZEICHEN_KEY = 'current_kennzeichen'; 
        const ARCHIVED_MONTHS_KEY = 'archived_months'; 
        const FEIERTAGE_KEY = 'feiertag_checked'; 
        const VACATION_KEY = 'vacation_days'; 
        const VACATION_TOGGLE_KEY = 'vacation_toggle_checked'; 
        
        // KENNZEICHENLISTE
        const KENNZEICHEN = ["WR-TP 11", "WR-TP 60", "WR-TP 75", "WR-TP 100", "WR-TP 103", "WR-TP 104", "WR-TP 105", "WR-TP 106", "WR-TP 111", "WR-TP 112", "WR-TP 119", "WR-TP 316", "WR-TP 444", "WR-TP 557", "WR-TP 667"];
        
        // --- DOM-Elemente ---
        const fahrernameInput = document.getElementById('fahrername');
        const kennzeichenSelect = document.getElementById('kennzeichen');
        const feiertagCheckbox = document.getElementById('feiertag-checkbox');
        const vacationToggleCheckbox = document.getElementById('vacation-toggle-checkbox'); 
        const vacationControlDiv = document.getElementById('vacation-control');           
        const uhrEl = document.getElementById('uhr');
        const statusDiv = document.getElementById('status');
        const btnStartStop = document.getElementById('btnStartStop');
        const btnPause = document.getElementById('btnPause');
        const btnMonthSummary = document.getElementById('btnMonthSummary'); 
        const summaryInfo = document.getElementById('summary-info');
        const archiveSelect = document.getElementById('archive-select');
        const btnRecreatePdf = document.getElementById('btnRecreatePdf');
        
        // NEUE DOM-Elemente f√ºr Urlaub (Datum)
        const vacationDateStart = document.getElementById('vacation-date-start');
        const vacationDateEnd = document.getElementById('vacation-date-end');
        const vacationInfoEl = document.getElementById('vacation-info');
        
        // NEUE DOM-Elemente f√ºr manuelle Eingabe
        const manualDateInput = document.getElementById('manual-date');
        const manualStartInput = document.getElementById('manual-start');
        const manualEndInput = document.getElementById('manual-end');
        const manualPauseInput = document.getElementById('manual-pause');


        // --- Globaler Zustand ---
        let state = loadState();
        let timer = null;

        function loadState() {
            const defaultState = { isWorking: false, isPaused: false, startTime: null, pauseTime: 0, pauseStart: null, log: [] };
            try {
                const storedState = JSON.parse(localStorage.getItem(STATE_KEY));
                if (storedState && storedState.startTime) storedState.startTime = Number(storedState.startTime);
                if (storedState && storedState.pauseStart) storedState.pauseStart = Number(storedState.pauseStart);
                if (storedState && !storedState.isPaused && storedState.pauseStart !== null) storedState.pauseStart = null;
                return storedState ? { ...defaultState, ...storedState } : defaultState;
            } catch (e) {
                return defaultState;
            }
        }
        
        function saveState() {
            localStorage.setItem(STATE_KEY, JSON.stringify(state));
        }
        
        // --- HILFSFUNKTIONEN F√úR DATUM & MONAT ---

        function getCurrentDate() {
            return new Date();
        }
        
        function getPreviousMonthKeyInfo(baseDate = getCurrentDate()) {
            const prevDate = new Date(baseDate.getFullYear(), baseDate.getMonth() - 1, 1);
            const year = prevDate.getFullYear();
            const month = String(prevDate.getMonth() + 1).padStart(2, '0');
            
            const monthName = prevDate.toLocaleDateString('de-DE', { month: 'long', year: 'numeric' });

            return { 
                key: `${year}-${month}`, 
                monthName: monthName,
                date: prevDate, 
                year: year,
                monthIndex: prevDate.getMonth() 
            };
        }

        function monthKeyToName(monthKey) {
             const [year, month] = monthKey.split('-');
             const date = new Date(parseInt(year), parseInt(month) - 1, 1);
             return date.toLocaleDateString("de-DE", { month: 'long', year: 'numeric' });
        }
        
        // --- Allgemeine Hilfsfunktionen ---
        
        function formatTime(ms) {
            const totalSeconds = Math.floor(ms / 1000);
            const h = String(Math.floor(totalSeconds / 3600)).padStart(2, '0');
            const m = String(Math.floor((totalSeconds % 3600) / 60)).padStart(2, '0');
            return `${h}:${m}`; 
        }
        
        function formatTimeDetailed(ms) {
             const totalSeconds = Math.floor(ms / 1000);
             const h = String(Math.floor(totalSeconds / 3600)).padStart(2, '0');
             const m = String(Math.floor((totalSeconds % 3600) / 60)).padStart(2, '0');
             const s = String(totalSeconds % 60).padStart(2, '0');
             return `${h}:${m}:${s}`;
        }
        
        function logAction(action, time) {
            const logEntry = { action: action, time: time.valueOf(), timestamp: time.toLocaleString("de-DE") };
            state.log.push(logEntry);
            saveState();
        }

        function isPreviousMonthCompleted() {
            const today = getCurrentDate(); 
            return today.getDate() === 1; 
        }

        function getCurrentMonthKey() {
            const today = getCurrentDate(); 
            const year = today.getFullYear();
            const month = String(today.getMonth() + 1).padStart(2, '0');
            return `${year}-${month}`;
        }
        
        // --- Feiertags-Logik (Sachsen-Anhalt) ---

        function getEasterSunday(year) {
            const a = year % 19;
            const b = Math.floor(year / 100);
            const c = year % 100;
            const d = Math.floor(b / 4);
            const e = b % 4;
            const g = Math.floor((8 * b + 13) / 25);
            const h = (19 * a + b - d - g + 15) % 30;
            const i = Math.floor(c / 4);
            const k = c % 4;
            const l = (32 + 2 * e + 2 * i - h - k) % 7;
            const m = Math.floor((a + 11 * h + 22 * l) / 451);
            const month = Math.floor((h + l - 7 * m + 114) / 31);
            const day = ((h + l - 7 * m + 114) % 31) + 1;
            
            const easterDate = new Date(year, month - 1, day);
            easterDate.setHours(0, 0, 0, 0); 
            return easterDate;
        }

        function isPublicHolidaySA(date) {
            const d = date.getDate();
            const m = date.getMonth() + 1; 
            const y = date.getFullYear();

            const fixedHolidays = [
                [1, 1],   // Neujahr
                [6, 1],   // Heilige Drei K√∂nige
                [1, 5],   // Tag der Arbeit
                [3, 10],  // Tag der Deutschen Einheit
                [31, 10], // Reformationstag
                [25, 12], // 1. Weihnachtstag
                [26, 12]  // 2. Weihnachtstag
            ];

            for (const [day, month] of fixedHolidays) {
                if (d === day && m === month) return true;
            }

            const easterSunday = getEasterSunday(y);
            const esMs = easterSunday.valueOf();
            
            const dateOnlyMs = new Date(y, m - 1, d).setHours(0, 0, 0, 0);

            const movableHolidaysMs = [
                esMs - (2 * 24 * 60 * 60 * 1000),      // Karfreitag (-2 Tage)
                esMs + (1 * 24 * 60 * 60 * 1000),       // Ostermontag (+1 Tag)
                esMs + (39 * 24 * 60 * 60 * 1000),      // Christi Himmelfahrt (+39 Tage)
                esMs + (50 * 24 * 60 * 60 * 1000)       // Pfingstmontag (+50 Tage)
            ];

            for (const holidayMs of movableHolidaysMs) {
                if (dateOnlyMs === holidayMs) return true;
            }

            return false;
        }

        // --- CHECKBOX UND UI LOGIK ---
        
        function initFeiertagCheckbox() {
            const storedFeiertag = localStorage.getItem(FEIERTAGE_KEY);
            if (storedFeiertag !== null) {
                feiertagCheckbox.checked = (storedFeiertag === 'true');
            }
            feiertagCheckbox.addEventListener('change', () => {
                localStorage.setItem(FEIERTAGE_KEY, feiertagCheckbox.checked);
            });
        }
        
        /**
         * Initialisiert die Urlaubs-Toggle-Checkbox und steuert die Anzeige des Blocks.
         */
        function initVacationToggle() {
            // Lade den gespeicherten Zustand des Toggles
            const storedVacationToggle = localStorage.getItem(VACATION_TOGGLE_KEY);
            if (storedVacationToggle !== null) {
                vacationToggleCheckbox.checked = (storedVacationToggle === 'true');
            }
            
            // Initialen Zustand des Blocks setzen
            toggleVacationBlock(vacationToggleCheckbox.checked);

            // Event Listener f√ºr Zustands√§nderung
            vacationToggleCheckbox.addEventListener('change', () => {
                const isChecked = vacationToggleCheckbox.checked;
                localStorage.setItem(VACATION_TOGGLE_KEY, isChecked);
                toggleVacationBlock(isChecked);
                
                if (!isChecked) {
                    // Wenn der Block ausgeblendet wird, die gespeicherten Urlaubstage l√∂schen
                    if (confirm("M√∂chten Sie die aktuell geplanten Urlaubstage l√∂schen, da Sie die Eingabe deaktivieren?")) {
                        localStorage.removeItem(VACATION_KEY);
                        vacationDateStart.value = '';
                        vacationDateEnd.value = '';
                        renderVacationInfo();
                    }
                }
            });
        }

        /**
         * Steuert die Sichtbarkeit des Urlaubs-Eingabeblocks.
         * @param {boolean} show - True, um den Block anzuzeigen, False, um ihn auszublenden.
         */
        function toggleVacationBlock(show) {
            if (show) {
                vacationControlDiv.classList.add('active');
            } else {
                vacationControlDiv.classList.remove('active');
            }
        }

        function resetKennzeichenDropdownSelection() {
            kennzeichenSelect.value = ''; 
            localStorage.removeItem(KENNZEICHEN_KEY); 
        }
        
        // --- URLAUBSFUNKTIONEN ---
        
        /**
         * Z√§hlt die Werktage (Mo-Fr) zwischen zwei Datumsangaben (inklusive),
         * die KEIN gesetzlicher Feiertag in Sachsen-Anhalt sind.
         */
        function countWorkingDays(startDate, endDate) {
            let count = 0;
            const currentDate = new Date(startDate);
            
            currentDate.setHours(0, 0, 0, 0); 
            endDate.setHours(0, 0, 0, 0); 

            while (currentDate.getTime() <= endDate.getTime()) {
                const dayOfWeek = currentDate.getDay(); // 0 = So, 6 = Sa
                
                // Pr√ºfe, ob es ein Wochentag (Mo-Fr) ist
                if (dayOfWeek !== 0 && dayOfWeek !== 6) {
                    
                    // Pr√ºfe, ob der Werktag KEIN Feiertag in Sachsen-Anhalt ist
                    if (!isPublicHolidaySA(currentDate)) {
                       count++;
                    }
                }
                currentDate.setDate(currentDate.getDate() + 1);
            }
            return count;
        }

        function saveVacationDays() {
            const startDateStr = vacationDateStart.value;
            const endDateStr = vacationDateEnd.value;

            if (!startDateStr || !endDateStr) {
                alert("Bitte w√§hlen Sie ein Start- und Enddatum f√ºr den Urlaub aus.");
                return;
            }
            
            // String-Daten auf 0 Uhr setzen
            const [y1, m1, d1] = startDateStr.split('-').map(Number);
            const startDate = new Date(y1, m1 - 1, d1);
            
            const [y2, m2, d2] = endDateStr.split('-').map(Number);
            const endDate = new Date(y2, m2 - 1, d2);
            
            if (startDate.getTime() > endDate.getTime()) {
                alert("Das Startdatum darf nicht nach dem Enddatum liegen.");
                return;
            }
            
            const days = countWorkingDays(startDate, endDate);

            if (days === 0) {
                 alert("Im gew√§hlten Zeitraum sind keine g√ºltigen Urlaubstage (Werktage abz√ºglich Feiertage/Wochenenden) enthalten.");
                 // L√∂sche alte Daten, falls vorhanden
                 localStorage.removeItem(VACATION_KEY); 
                 renderVacationInfo();
                 return;
            }
            
            const vacationData = { 
                startDate: startDateStr, 
                endDate: endDateStr, 
                totalWorkingDays: days 
            };
            localStorage.setItem(VACATION_KEY, JSON.stringify(vacationData));
            
            alert(`Urlaubszeitraum von ${startDateStr} bis ${endDateStr} gespeichert. Automatisch berechnete Werktage (ohne Feiertage): ${days}.`);
            renderVacationInfo();
        }
        
        function loadVacationData() {
            try {
                const data = JSON.parse(localStorage.getItem(VACATION_KEY));
                if (data && data.startDate) {
                    const [y1, m1, d1] = data.startDate.split('-').map(Number);
                    data.startDateObj = new Date(y1, m1 - 1, d1);
                    data.startDateObj.setHours(0, 0, 0, 0); 
                }
                if (data && data.endDate) {
                    const [y2, m2, d2] = data.endDate.split('-').map(Number);
                    data.endDateObj = new Date(y2, m2 - 1, d2);
                    data.endDateObj.setHours(0, 0, 0, 0); 
                }
                return data;
            } catch (e) {
                return null;
            }
        }
        
        function renderVacationInfo() {
            const data = loadVacationData();
            if (data) {
                vacationInfoEl.textContent = `Aktuell: ${data.totalWorkingDays} Werktage Urlaub geplant (Von ${data.startDate} bis ${data.endDate}).`;
                vacationInfoEl.className = 'text-xs text-green-400 mt-2 font-semibold';
                
                // Setze die Kalender-Inputs, falls Daten geladen werden
                vacationDateStart.value = data.startDate;
                vacationDateEnd.value = data.endDate;
                
            } else {
                vacationInfoEl.textContent = 'Aktuell: Keine Urlaubstage definiert.';
                vacationInfoEl.className = 'text-xs text-gray-400 mt-2';
            }
        }
        
        // --- FUNKTION ZUR MANUELLEN NACHERFASSUNG ---

        /**
         * Schaltet die Sichtbarkeit des Blocks f√ºr die manuelle Schichteingabe um.
         */
        function toggleManualShiftInput() {
            const container = document.getElementById('manual-shift-container');
            const icon = document.getElementById('manual-toggle-icon');
            const btn = document.getElementById('btnToggleManual');
            
            if (container.style.display === 'none') {
                container.style.display = 'block';
                icon.textContent = '‚ûñ';
                btn.querySelector('span:last-child').textContent = 'Manuelle Schichteingabe (Nachtrag) ausblenden';
            } else {
                container.style.display = 'none';
                icon.textContent = '‚ûï';
                btn.querySelector('span:last-child').textContent = 'Manuelle Schichteingabe (Nachtrag) anzeigen';
            }
        }

        function submitManualShift() {
            const dateStr = manualDateInput.value;
            const startTimeStr = manualStartInput.value;
            const endTimeStr = manualEndInput.value;
            const pauseMinutes = parseInt(manualPauseInput.value, 10);
            
            if (!dateStr || !startTimeStr || !endTimeStr || isNaN(pauseMinutes)) {
                alert("Bitte f√ºllen Sie alle Felder aus (Datum, Start, Ende, Pause).");
                return;
            }

            const [startHour, startMinute] = startTimeStr.split(':').map(Number);
            const [endHour, endMinute] = endTimeStr.split(':').map(Number);
            
            // Datum und Uhrzeit zusammenf√ºhren
            const dateParts = dateStr.split('-');
            const year = Number(dateParts[0]);
            const month = Number(dateParts[1]) - 1; // JS Monate sind 0-basiert
            const day = Number(dateParts[2]);

            const startDateTime = new Date(year, month, day, startHour, startMinute, 0);
            let endDateTime = new Date(year, month, day, endHour, endMinute, 0);
            
            const startTime = startDateTime.valueOf();
            let endTime = endDateTime.valueOf();
            
            // √úberpr√ºfen, ob die Endzeit am n√§chsten Tag liegt
            if (endTime <= startTime) {
                 if (!confirm("Die Endzeit liegt vor oder gleich der Startzeit. Soll die Endzeit automatisch auf den n√§chsten Tag gesetzt werden (z.B. Nachtschicht)?")) {
                      return;
                 }
                 endDateTime.setDate(endDateTime.getDate() + 1); // Setze das Datum der Endzeit auf den n√§chsten Tag
                 endTime = endDateTime.valueOf();
            }
            
            const bruttoTimeMs = endTime - startTime;
            const pauseTimeMs = pauseMinutes * 60 * 1000;
            const netTimeMs = bruttoTimeMs - pauseTimeMs;
            
            if (netTimeMs < 0) {
                 alert("Fehler: Die Pausenzeit ist l√§nger als die Brutto-Arbeitszeit. Bitte korrigieren Sie die Eingaben.");
                 return;
            }
            
            const selectedKZ = kennzeichenSelect.value;
            if (selectedKZ === '') {
                 alert("Bitte w√§hlen Sie das Kennzeichen f√ºr die nachgetragene Schicht aus.");
                 return;
            }
            
            if (!fahrernameInput.value.trim()) {
                 alert("Bitte geben Sie Ihren Namen ein.");
                 return;
            }
            
            // Schicht-Objekt erstellen
            const newShift = {
                fahrer: fahrernameInput.value, 
                kennzeichen: selectedKZ, 
                netTime: netTimeMs, 
                startTime: startTime, 
                log: [
                    { action: "Arbeitsbeginn (Manuell)", time: startTime, timestamp: startDateTime.toLocaleString("de-DE") },
                    { action: `Pause (Manuell) ${pauseMinutes} Min.`, time: startTime + (bruttoTimeMs / 2), timestamp: new Date(startTime + (bruttoTimeMs / 2)).toLocaleString("de-DE") }, 
                    { action: "Arbeitsende (Manuell)", time: endTime, timestamp: endDateTime.toLocaleString("de-DE") }
                ],
                bemerkungen: `Nachtrag: Brutto ${formatTime(bruttoTimeMs)}, Pause ${pauseMinutes} Min. (${formatTime(pauseTimeMs)})`
            };

            // Im LocalStorage speichern
            const yearKey = startDateTime.getFullYear();
            const monthKey = String(startDateTime.getMonth() + 1).padStart(2, '0');
            const currentMonthKey = `${yearKey}-${monthKey}`;
            
            let shiftsByMonth = JSON.parse(localStorage.getItem(SHIFTS_KEY)) || {};
            if (!shiftsByMonth[currentMonthKey]) {
                shiftsByMonth[currentMonthKey] = [];
            }
            
            // F√ºge die neue Schicht hinzu
            shiftsByMonth[currentMonthKey].push(newShift);
            
            localStorage.setItem(SHIFTS_KEY, JSON.stringify(shiftsByMonth));
            
            alert(`Schicht vom ${dateStr} wurde erfolgreich nachgetragen. Nettozeit: ${formatTime(netTimeMs)}.`);
            
            // UI aktualisieren
            renderShiftSummary();
        }
        
        // --- PDF-FUNKTIONEN ---
        
        async function createMonthSummaryPDF(shiftsToExport, monthInfo) {
            const doc = new jsPDF('l', 'mm', 'a4'); // 'l' f√ºr Landscape (Querformat)
            const fahrerName = fahrernameInput.value || "Unbekannt";
            let totalNetTimeMs = 0;
            let totalBruttoTimeMs = 0;
            let totalPauseTimeMs = 0;
            let totalDocumentedVacationDays = 0; 
            
            const vacationData = loadVacationData();
            const getDayOfWeek = (date) => date.toLocaleDateString('de-DE', { weekday: 'short' });
            
            const getShiftsForDay = (dayOfMonth, shifts) => {
                // Filtere Schichten, die an diesem Tag starten
                return shifts.filter(shift => {
                    const shiftDate = new Date(shift.startTime);
                    return shiftDate.getDate() === dayOfMonth && shiftDate.getMonth() === monthInfo.monthIndex && shiftDate.getFullYear() === monthInfo.year;
                });
            };
            
            const dataForMonth = [];
            const daysInMonth = new Date(monthInfo.year, monthInfo.monthIndex + 1, 0).getDate();
            const feiertagChecked = feiertagCheckbox.checked;

            for (let day = 1; day <= daysInMonth; day++) {
                const date = new Date(monthInfo.year, monthInfo.monthIndex, day);
                const dateOnlyMs = date.setHours(0, 0, 0, 0); 
                
                const currentDayDate = new Date(dateOnlyMs);
                const dayOfWeek = currentDayDate.getDay(); // 0 = So, 6 = Sa
                const isWeekend = (dayOfWeek === 0 || dayOfWeek === 6);
                const isWeekday = (dayOfWeek >= 1 && dayOfWeek <= 5);
                
                // === Feiertags-Check (SA-weit) ===
                const isPublicHoliday = isPublicHolidaySA(currentDayDate);
                
                const shiftsForDay = getShiftsForDay(day, shiftsToExport);
                
                // === Urlaubs-Check ===
                let isCurrentVacationDay = false;
                if (vacationData && vacationData.startDateObj && vacationData.endDateObj) {
                     // Pr√ºfe, ob der Tag im Zeitraum liegt UND ein g√ºltiger Urlaubstag ist (Werktag, kein Feiertag)
                     if (dateOnlyMs >= vacationData.startDateObj.getTime() && dateOnlyMs <= vacationData.endDateObj.getTime()) {
                         if (isWeekday && !isPublicHoliday) {
                             isCurrentVacationDay = true;
                         }
                     }
                }
                
                if (shiftsForDay.length > 0) {
                    // Fall 1: Gearbeitet 
                    shiftsForDay.forEach(shift => {
                        const startDateTime = new Date(shift.startTime);
                        const endEntry = shift.log.slice().reverse().find(e => e.action.startsWith('Arbeitsende')); 
                        const endDateTime = endEntry ? new Date(endEntry.time) : null;
                        
                        let bruttoTimeMs = 0;
                        let pauseTimeMs = 0;
                        
                        if (endDateTime) {
                            bruttoTimeMs = endDateTime.valueOf() - startDateTime.valueOf();
                            pauseTimeMs = bruttoTimeMs - shift.netTime;
                        } else {
                            // Wenn keine Endzeit geloggt, aber Nettzeit > 0, ist dies ein Fehler oder die Schicht ist aktuell (sollte hier nicht passieren)
                            return; 
                        }
                        
                        totalNetTimeMs += shift.netTime;
                        totalBruttoTimeMs += bruttoTimeMs;
                        totalPauseTimeMs += pauseTimeMs;
                        
                        let bemerkungenText = shift.bemerkungen || "";
                        
                        // Bemerkung: Feiertag hinzuf√ºgen (wenn Checkbox aktiv ODER Feiertag ist)
                        if (feiertagCheckbox.checked || isPublicHoliday) {
                            const feiertagText = "Feiertag (Gearbeitet)";
                            if (!bemerkungenText.toLowerCase().includes(feiertagText.toLowerCase())) {
                                bemerkungenText = (bemerkungenText ? bemerkungenText + " | " : "") + feiertagText;
                            }
                        }

                        dataForMonth.push({
                            type: 'shift',
                            date: currentDayDate,
                            datumText: currentDayDate.toLocaleDateString("de-DE", { day: '2-digit', month: '2-digit' }),
                            wochentag: getDayOfWeek(currentDayDate),
                            kennzeichen: shift.kennzeichen,
                            von: startDateTime.toLocaleTimeString("de-DE", { hour: '2-digit', minute: '2-digit' }),
                            bis: endDateTime ? endDateTime.toLocaleTimeString("de-DE", { hour: '2-digit', minute: '2-digit' }) : 'N/A',
                            brutto: formatTime(bruttoTimeMs),
                            pause: formatTime(pauseTimeMs),
                            netto: formatTime(shift.netTime),
                            bemerkungen: bemerkungenText
                        });
                    });
                } else if (isPublicHoliday && !isWeekend) { 
                     // Fall 2: Feiertag (ohne Arbeit, aber Werktag)
                     let bemerkungenText = "Feiertag (Lohnfortzahlung)";
                     
                     dataForMonth.push({
                         type: 'rest',
                         date: currentDayDate,
                         datumText: currentDayDate.toLocaleDateString("de-DE", { day: '2-digit', month: '2-digit' }),
                         wochentag: getDayOfWeek(currentDayDate),
                         kennzeichen: 'FEIERTAG',
                         von: '---', bis: '---', brutto: '---', pause: '---', netto: '---', 
                         bemerkungen: bemerkungenText,
                         isHolidayEntry: true
                     });
                     
                } else if (isCurrentVacationDay) {
                     // Fall 3: Urlaubstag (Werktag, keine Arbeit, KEIN Feiertag)
                     totalDocumentedVacationDays++;
                     dataForMonth.push({
                         type: 'vacation',
                         date: currentDayDate,
                         datumText: currentDayDate.toLocaleDateString("de-DE", { day: '2-digit', month: '2-digit' }),
                         wochentag: getDayOfWeek(currentDayDate),
                         kennzeichen: 'URLAUB',
                         von: '---', bis: '---', brutto: '---', pause: '---', netto: '---', 
                         bemerkungen: 'Urlaub'
                     });
                } else if (isWeekend) {
                     // Fall 4: Ruhetag (Wochenende)
                     dataForMonth.push({
                         type: 'rest',
                         date: currentDayDate,
                         datumText: currentDayDate.toLocaleDateString("de-DE", { day: '2-digit', month: '2-digit' }),
                         wochentag: getDayOfWeek(currentDayDate),
                         kennzeichen: 'Ruhetag (WE)',
                         von: '---', bis: '---', brutto: '---', pause: '---', netto: '---', 
                         bemerkungen: ''
                     });
                }
            }

            // PDF-Tabelle aufbereiten
            const tableRows = dataForMonth
                .sort((a, b) => a.date.getTime() - b.date.getTime()) // Sortierung nach Datum sicherstellen
                .map(item => [
                     item.wochentag, 
                     item.datumText, 
                     item.kennzeichen, 
                     item.von, 
                     item.bis, 
                     item.brutto, 
                     item.pause, 
                     item.netto, 
                     item.bemerkungen
                ]);


            // Tabelle definieren (9 Spaltennamen)
            const tableColumn = ["Wochentag", "Datum", "Schicht", "Von", "Bis", "Brutto", "Pause", "Netto", "Bemerkungen"];
            const headerStart = 10;
            const titleStart = 30;

            // --- KOPFZEILE ---
            doc.setFontSize(10);
            doc.text("Taxi Pfeiffer", 14, headerStart);
            doc.text("Westerh√§user Landstr. 17", 14, headerStart + 5); 
            doc.text("38889 Blankenburg", 14, headerStart + 10); 

            // Stundenabrechnungstitel
            doc.setFontSize(12);
            doc.text(`Stundenabrechnung von ${fahrerName} f√ºr den Monat:`, 14, titleStart);
            
            // Monatsname und Datumsbereich
            doc.setFontSize(14);
            doc.text(monthInfo.monthName, 14, titleStart + 5); 
            doc.setFontSize(10);
            const endDateOfMonth = new Date(monthInfo.year, monthInfo.monthIndex + 1, 0);
            doc.text(`01.${monthInfo.key.substring(5, 7)}.${monthInfo.key.substring(0, 4)} - ${endDateOfMonth.getDate()}.${monthInfo.key.substring(5, 7)}.${monthInfo.key.substring(0, 4)}`, 14, titleStart + 10);

            // Fu√üzeile (Gesamt) definieren
            const tableFoot = [
                [
                    { content: "GESAMT:", colSpan: 5, styles: { halign: 'left' } }, 
                    { content: formatTime(totalBruttoTimeMs) }, 
                    { content: formatTime(totalPauseTimeMs) }, 
                    { content: formatTime(totalNetTimeMs) },
                    "" 
                ]
            ];
            
            // NEU: Zeile f√ºr Urlaubstage hinzuf√ºgen
            if (vacationData) {
                 const monthTotal = vacationData.totalWorkingDays;
                
                 tableFoot.push([
                    { content: `URLAUBSPLANUNG (${monthTotal} Werktage gesamt, ohne Feiertage):`, colSpan: 5, styles: { halign: 'left', fontStyle: 'normal', textColor: [55, 65, 81] } },
                    { content: `DOKUMENTIERT IN ${monthInfo.monthName}: ${totalDocumentedVacationDays} Tage`, colSpan: 4, styles: { halign: 'left', fontStyle: 'normal', textColor: [55, 65, 81] } }
                 ]);
            }
            
            const tableStartY = 50; 

            // --- Tabelle hinzuf√ºgen ---
            doc.autoTable({
                head: [tableColumn],
                body: tableRows,
                foot: tableFoot,
                startY: tableStartY,
                headStyles: { fillColor: [220, 230, 240], textColor: [0, 0, 0], fontStyle: 'bold' },
                footStyles: {
                    fillColor: [55, 65, 81], 
                    textColor: [252, 211, 77], 
                    fontStyle: 'bold', 
                    fontSize: 9, 
                    halign: 'center' 
                },
                styles: { fontSize: 9, cellPadding: 2, lineWidth: 0.1, lineColor: 0 },
                columnStyles: {
                    0: { cellWidth: 16 }, 
                    1: { cellWidth: 14 }, 
                    2: { cellWidth: 30 }, 
                    3: { cellWidth: 14, halign: 'center' }, 
                    4: { cellWidth: 14, halign: 'center' }, 
                    5: { cellWidth: 15, halign: 'center' }, 
                    6: { cellWidth: 15, halign: 'center' }, 
                    7: { cellWidth: 15, halign: 'center' }, 
                    8: { cellWidth: 40 } 
                },
                margin: { top: 10, left: 14, right: 14 }
            });
            
            const finalY = doc.autoTable.previous.finalY || tableStartY + 10;

            // Unterschriftenfelder
            doc.setFontSize(10);
            doc.setTextColor(0); 
            
            doc.text("Datum und Unterschrift Arbeitgeber", 14, finalY + 30);
            
            const sigText = "Datum und Unterschrift Arbeitnehmer";
            const pageWidth = doc.internal.pageSize.getWidth();
            doc.text(sigText, pageWidth - 14, finalY + 30, { align: 'right' });

            const pdfBlob = doc.output('blob');
            return pdfBlob;
        }

        // --- HAUPTFUNKTIONEN (unver√§ndert, au√üer initializeStatus) ---
        
        function startTimer() {
             if (timer) clearInterval(timer);
             timer = setInterval(updateTime, 1000);
        }

        function stopTimer() {
             if (timer) clearInterval(timer);
             timer = null;
        }

        function updateTime() {
             const now = getCurrentDate().valueOf();
             let elapsed;

             if (state.isWorking) {
                 if (state.isPaused) {
                     elapsed = (now - state.startTime) - state.pauseTime;
                     if (state.pauseStart) elapsed -= (now - state.pauseStart);
                 } else {
                     elapsed = (now - state.startTime) - state.pauseTime;
                 }
             } else {
                 elapsed = 0;
             }

             uhrEl.textContent = `${formatTimeDetailed(elapsed)} (Nettozeit heute)`;
             updateUI();
        }

        function togglePause() {
             const now = getCurrentDate().valueOf();
             if (!state.isWorking) return;

             if (!state.isPaused) {
                 // Pause starten
                 state.isPaused = true;
                 state.pauseStart = now;
                 logAction('Pause Start', getCurrentDate());
                 stopTimer();
             } else {
                 // Pause beenden
                 state.isPaused = false;
                 if (state.pauseStart) {
                     state.pauseTime += now - state.pauseStart;
                 }
                 state.pauseStart = null;
                 logAction('Pause Ende', getCurrentDate());
                 startTimer();
             }
             saveState();
             updateUI();
        }

        function updateUI() {
             if (state.isWorking) {
                 btnStartStop.textContent = state.isPaused ? "Fortsetzen" : "Speichern & Beenden";
                 btnStartStop.className = `action-btn w-full font-bold py-3 rounded-lg text-lg ${state.isPaused ? 'bg-green-600 hover:bg-green-700 text-white' : 'bg-red-600 hover:bg-red-700 text-white'}`;
                 
                 btnPause.disabled = false;
                 btnPause.textContent = state.isPaused ? "Weiter" : "Pause";
                 
                 statusDiv.textContent = state.isPaused ? "Pausiert" : "L√§uft";
                 statusDiv.className = `status ${state.isPaused ? 'paused' : 'working'}`;
             } else {
                 btnStartStop.textContent = "Starten / Speichern";
                 btnStartStop.className = 'action-btn w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 rounded-lg text-lg';
                 
                 btnPause.disabled = true;
                 btnPause.textContent = "Pause";
                 
                 statusDiv.textContent = "Gestoppt";
                 statusDiv.className = 'status stopped';
             }
             
             // Update Kennzeichen/Fahrer
             fahrernameInput.disabled = state.isWorking;
             kennzeichenSelect.disabled = state.isWorking;
             feiertagCheckbox.disabled = state.isWorking;
             vacationToggleCheckbox.disabled = state.isWorking; 
             
             // Update Nettozeit, wenn gestoppt
             if (!state.isWorking && state.startTime) {
                 const netTime = (getCurrentDate().valueOf() - state.startTime) - state.pauseTime;
                 uhrEl.textContent = `${formatTimeDetailed(netTime)} (Nettozeit heute)`;
             } else if (!state.startTime) {
                 uhrEl.textContent = "00:00:00 (Nettozeit heute)";
             }
        }
        
        async function createMonthSummary() {
            
             if (!isPreviousMonthCompleted()) {
                 alert("Aktion nicht m√∂glich: Die Abrechnung ist nur ab dem 1. Tag des Monats erlaubt.");
                 return;
             }

             const previousMonthInfo = getPreviousMonthKeyInfo(getCurrentDate()); 
             const shiftsByMonth = JSON.parse(localStorage.getItem(SHIFTS_KEY)) || {};
             const shiftsToExport = shiftsByMonth[previousMonthInfo.key] || [];
             
             if (!confirm(`Sicher? Das PDF f√ºr ${previousMonthInfo.monthName} mit ${shiftsToExport.length} Schichten (plus Ruhetage) wird jetzt heruntergeladen. Die Daten bleiben im Protokoll gespeichert (Archiv).`)) {
                 return;
             }
            
            const fahrerNameClean = fahrernameInput.value.replace(/\s/g, '_');
            const fileName = `Zeiterfassung_${fahrerNameClean}_${previousMonthInfo.key}.pdf`;
            const pdfBlob = await createMonthSummaryPDF(shiftsToExport, previousMonthInfo);

            initiateDownload(pdfBlob, fileName); 
            
            let archivedMonths = JSON.parse(localStorage.getItem(ARCHIVED_MONTHS_KEY)) || [];
            if (!archivedMonths.includes(previousMonthInfo.key)) {
                archivedMonths.push(previousMonthInfo.key);
                localStorage.setItem(ARCHIVED_MONTHS_KEY, JSON.stringify(archivedMonths));
            }
            
            initializeStatus();

            const userAlertMessage = `
            ===================================================
            ‚úÖ MONATSABRECHNUNG ERSTELLT ‚úÖ
            ===================================================
            
            Die Abrechnung f√ºr ${previousMonthInfo.monthName} wurde erfolgreich erstellt.
            
            Das PDF wurde heruntergeladen und hei√üt:
            "${fileName}" (Im Downloads-Ordner)
            `;

            setTimeout(() => {
                 alert(userAlertMessage);
            }, 500); 

        }
        
        function startStopTracking() {
            const now = getCurrentDate().valueOf();
            const isFeiertag = feiertagCheckbox.checked;

            if (fahrernameInput.value.trim() === '') { 
                 alert("Bitte Namen eingeben."); 
                 return; 
            }
            
            if (kennzeichenSelect.value === '' && !isFeiertag && !state.isWorking) { 
                 alert("Bitte Kennzeichen ausw√§hlen."); 
                 return; 
            }

            if (kennzeichenSelect.value !== '') {
                localStorage.setItem(KENNZEICHEN_KEY, kennzeichenSelect.value); 
            }
            
            if (!state.isWorking) {
                if (isFeiertag) {
                    
                    let bemerkungen = prompt("Geben Sie optional eine Bemerkung f√ºr diesen Feiertag (ohne Arbeit) ein:");
                    const feiertagText = "Feiertag (Keine Arbeitszeit)";
                    
                    if (bemerkungen) {
                         if (!bemerkungen.toLowerCase().includes(feiertagText.toLowerCase())) {
                             bemerkungen += " | " + feiertagText;
                         }
                    } else {
                        bemerkungen = feiertagText;
                    }

                    const newShift = {
                        fahrer: fahrernameInput.value, 
                        kennzeichen: kennzeichenSelect.value || 'FEIERTAG', 
                        netTime: 0, 
                        startTime: now, 
                        log: [{ action: "Feiertag gespeichert", time: now, timestamp: getCurrentDate().toLocaleString("de-DE") }],
                        bemerkungen: bemerkungen || '' 
                    };
                    
                    const currentMonthKey = getCurrentMonthKey(); 
                    let shiftsByMonth = JSON.parse(localStorage.getItem(SHIFTS_KEY)) || {};
                    
                    if (!shiftsByMonth[currentMonthKey]) {
                        shiftsByMonth[currentMonthKey] = [];
                    }
                    shiftsByMonth[currentMonthKey].push(newShift);
                    localStorage.setItem(SHIFTS_KEY, JSON.stringify(shiftsByMonth));

                    resetKennzeichenDropdownSelection(); 
                    feiertagCheckbox.checked = false;
                    localStorage.setItem(FEIERTAGE_KEY, 'false'); 
                    initializeStatus(); 
                    renderShiftSummary();
                    
                    alert(`Feiertag (ohne Arbeit) erfolgreich f√ºr heute gespeichert. Bemerkung: "${bemerkungen}"`);
                    return;
                }
                
                // Normale Arbeitszeiterfassung
                if (state.log.length === 0 || !state.startTime) { state.startTime = now; state.pauseTime = 0; logAction('Arbeitsbeginn', getCurrentDate()); } 
                else { logAction('Arbeitsbeginn (Fortsetzung)', getCurrentDate()); }
                state.isWorking = true; state.isPaused = false; startTimer();
                
            } else {
                // Stoppen und Speichern einer normalen Schicht
                if (state.isPaused) { togglePause(); } 
                
                if (confirm("M√∂chten Sie die Zeiterfassung stoppen und die Schicht speichern (Tag beenden)?")) {
                    
                    let bemerkungen = prompt("Geben Sie optional eine Bemerkung f√ºr diesen Tag ein:");
                    
                    if (isFeiertag) {
                         const feiertagText = "Feiertag (Gearbeitet)";
                         if (bemerkungen) {
                             if (!bemerkungen.toLowerCase().includes(feiertagText.toLowerCase())) {
                                 bemerkungen += " | " + feiertagText;
                             }
                         } else {
                             bemerkungen = feiertagText;
                         }
                    }
                    
                    if (state.isWorking && state.isPaused && state.pauseStart) { state.pauseTime += now - state.pauseStart; }
                    
                    logAction('Arbeitsende (Tag beendet)', getCurrentDate()); 
                    const netTime = (now - state.startTime) - state.pauseTime;

                    const newShift = {
                        fahrer: fahrernameInput.value, 
                        kennzeichen: localStorage.getItem(KENNZEICHEN_KEY) || kennzeichenSelect.value, 
                        netTime: netTime, 
                        startTime: state.startTime, 
                        log: state.log,
                        bemerkungen: bemerkungen || '' 
                    };
                    
                    const currentMonthKey = getCurrentMonthKey(); 
                    let shiftsByMonth = JSON.parse(localStorage.getItem(SHIFTS_KEY)) || {};
                    
                    if (!shiftsByMonth[currentMonthKey]) {
                        shiftsByMonth[currentMonthKey] = [];
                    }
                    shiftsByMonth[currentMonthKey].push(newShift);

                    localStorage.setItem(SHIFTS_KEY, JSON.stringify(shiftsByMonth));
                    
                    stopTimer();
                    localStorage.removeItem(STATE_KEY); 
                    state = loadState(); 
                    
                    resetKennzeichenDropdownSelection(); 
                    feiertagCheckbox.checked = false;
                    localStorage.setItem(FEIERTAGE_KEY, 'false'); 
                    
                    initializeStatus(); 
                    
                    alert(`Tag beendet! Netto-Arbeitszeit: ${formatTimeDetailed(netTime)} wurde gespeichert.`);

                } else {
                    state.isWorking = false; stopTimer(); logAction('Arbeitsende (Zwischenstopp)', getCurrentDate());
                }
            }
            saveState(); 
            updateUI();
            renderShiftSummary(); 
        }
        
        function populateKennzeichenDropdown() {
             kennzeichenSelect.innerHTML = '<option value="" disabled selected class="text-gray-500">Kennzeichen ausw√§hlen...</option>';
             KENNZEICHEN.forEach(kz => {
                 const option = document.createElement('option');
                 option.value = kz;
                 option.textContent = kz;
                 kennzeichenSelect.appendChild(option);
             });
             
             const storedKZ = localStorage.getItem(KENNZEICHEN_KEY);
             if (storedKZ) {
                 kennzeichenSelect.value = storedKZ;
             }
        }
        
        function renderShiftSummary() {
            const list = document.getElementById('shift-summary-list');
            list.innerHTML = '';
            
            const shiftsByMonth = JSON.parse(localStorage.getItem(SHIFTS_KEY)) || {};
            const monthKeys = Object.keys(shiftsByMonth).sort().reverse(); 
            let totalNetMsAllTime = 0;
            let totalShiftsCount = 0;

            monthKeys.forEach(monthKey => {
                 const monthShifts = shiftsByMonth[monthKey] || [];
                 if (monthShifts.length === 0) return;
                 
                 const monthHeader = document.createElement('h4');
                 monthHeader.className = 'text-lg font-bold text-gray-300 mt-4 mb-2 border-b border-gray-700 pb-1';
                 monthHeader.textContent = monthKeyToName(monthKey);
                 list.appendChild(monthHeader);
                 
                 monthShifts.sort((a, b) => b.startTime - a.startTime).forEach(shift => {
                     totalShiftsCount++;
                     totalNetMsAllTime += shift.netTime;

                     const shiftDate = new Date(shift.startTime).toLocaleDateString("de-DE", { day: '2-digit', month: '2-digit', year: 'numeric' });
                     let netTime = formatTime(shift.netTime);
                     let timeDisplay = `Netto: ${netTime}`;
                     let shiftClass = 'summary-shift';

                     // Detailansicht nur f√ºr gearbeitete Schichten
                     let bruttoTime = 'N/A';
                     let pauseTime = 'N/A';
                     const endEntry = shift.log.slice().reverse().find(e => e.action.includes('Arbeitsende'));
                     
                     if (endEntry) {
                          const bruttoTimeMs = endEntry.time - shift.startTime;
                          const pauseTimeMs = bruttoTimeMs - shift.netTime;
                          bruttoTime = formatTime(bruttoTimeMs);
                          pauseTime = formatTime(pauseTimeMs);
                          
                          timeDisplay = `Brutto: ${bruttoTime}, Pause: ${pauseTime}, Netto: ${netTime}`;
                          
                          if (shift.bemerkungen && shift.bemerkungen.startsWith('Nachtrag:')) {
                               shiftClass += ' border-left: 4px solid #f97316;'; // Orange f√ºr nachtr√§gliche Schichten
                          }
                     }
                      
                     // Pr√ºfen, ob die Schicht die aktuell laufende ist (nur wenn keine Arbeitsende-Log existiert und sie im State ist)
                     const shiftEnd = shift.log.find(e => e.action.includes('Arbeitsende'));
                     if (!shiftEnd && state.isWorking && state.startTime === shift.startTime) {
                         shiftClass += ' current-shift'; 
                         const currentNet = (getCurrentDate().valueOf() - state.startTime) - state.pauseTime;
                         timeDisplay = `L√ÑUFT AKTUELL (Netto: ${formatTime(currentNet)}) - [Seit ${new Date(shift.startTime).toLocaleTimeString("de-DE")}]`;
                     }


                     const shiftEl = document.createElement('div');
                     shiftEl.className = shiftClass;
                     shiftEl.innerHTML = `
                         <p class="text-sm font-semibold">${shiftDate} | ${shift.kennzeichen}</p>
                         <p class="text-xs text-gray-400">${timeDisplay}</p>
                         <p class="text-xs text-blue-400 mt-1">${shift.bemerkungen ? `Bemerkung: ${shift.bemerkungen}` : ''}</p>
                     `;
                     list.appendChild(shiftEl);
                 });
            });
            
            if (totalShiftsCount === 0) {
                 list.innerHTML = '<p class="text-gray-400">Noch keine abgeschlossenen Schichten gespeichert.</p>';
            }

            const overallSummary = document.createElement('div');
            overallSummary.className = 'bg-gray-700 p-3 rounded-lg mt-4';
            overallSummary.innerHTML = `
                <p class="text-sm font-bold text-yellow-400">Gesamt-Nettozeit aller gespeicherten Schichten:</p>
                <p class="text-lg font-extrabold text-white">${formatTimeDetailed(totalNetMsAllTime)}</p>
            `;
            list.prepend(overallSummary);
        }

        function populateArchiveDropdown() {
             archiveSelect.innerHTML = '<option value="" disabled selected class="text-gray-500">Abrechnungen ausw√§hlen...</option>';
             const archivedMonths = JSON.parse(localStorage.getItem(ARCHIVED_MONTHS_KEY)) || [];
             
             const sortedMonths = archivedMonths.sort().reverse();
             
             if (sortedMonths.length === 0) {
                 archiveSelect.disabled = true;
                 btnRecreatePdf.disabled = true;
                 return;
             }
             
             archiveSelect.disabled = false;
             
             sortedMonths.forEach(monthKey => {
                 const option = document.createElement('option');
                 option.value = monthKey;
                 option.textContent = monthKeyToName(monthKey);
                 archiveSelect.appendChild(option);
             });
             
             archiveSelect.onchange = () => {
                btnRecreatePdf.disabled = !archiveSelect.value;
             };
        }

        async function recreatePdfFromArchive() {
            const selectedMonthKey = archiveSelect.value;
            if (!selectedMonthKey) return;
            
            const [year, month] = selectedMonthKey.split('-').map(Number);
            const monthInfo = {
                key: selectedMonthKey,
                year: year,
                monthIndex: month - 1,
                monthName: monthKeyToName(selectedMonthKey)
            };
            
            const shiftsByMonth = JSON.parse(localStorage.getItem(SHIFTS_KEY)) || {};
            const shiftsToExport = shiftsByMonth[selectedMonthKey] || [];
            
            if (shiftsToExport.length === 0) {
                alert(`Keine Schichtdaten f√ºr ${monthInfo.monthName} gefunden.`);
                return;
            }
            
            if (!confirm(`Sicher? Das PDF f√ºr ${monthInfo.monthName} wird erneut erstellt.`)) {
                 return;
            }
            
            const fahrerNameClean = fahrernameInput.value.replace(/\s/g, '_');
            const fileName = `Zeiterfassung_REPRINT_${fahrerNameClean}_${selectedMonthKey}.pdf`;
            const pdfBlob = await createMonthSummaryPDF(shiftsToExport, monthInfo);

            initiateDownload(pdfBlob, fileName);
            alert(`PDF f√ºr ${monthInfo.monthName} wurde neu erstellt und heruntergeladen.`);
        }

        function initiateDownload(blob, fileName) {
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = fileName;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }
        
        function deleteAllData() {
             if (confirm("WARNUNG: Sind Sie sicher, dass Sie ALLE gespeicherten Schichtdaten, Archive und den aktuellen Timer-Status l√∂schen m√∂chten? Diese Aktion kann nicht r√ºckg√§ngig gemacht werden.")) {
                 localStorage.removeItem(SHIFTS_KEY);
                 localStorage.removeItem(STATE_KEY);
                 localStorage.removeItem(ARCHIVED_MONTHS_KEY);
                 localStorage.removeItem(KENNZEICHEN_KEY);
                 localStorage.removeItem(FEIERTAGE_KEY);
                 localStorage.removeItem(VACATION_KEY); 
                 localStorage.removeItem(VACATION_TOGGLE_KEY);
                 
                 stopTimer();
                 state = loadState();
                 initializeStatus();
                 renderShiftSummary();
                 
                 alert("Alle Daten erfolgreich gel√∂scht. Die App ist zur√ºckgesetzt.");
             }
        }

        // --- Initialisierung ---
        
        function initializeStatus() {
             initFeiertagCheckbox(); 
             initVacationToggle(); 
             populateKennzeichenDropdown();
             renderVacationInfo(); 
             
             fahrernameInput.value = localStorage.getItem(NAME_KEY) || '';
             
             fahrernameInput.addEventListener('input', () => {
                 localStorage.setItem(NAME_KEY, fahrernameInput.value);
                 renderShiftSummary();
                 if (fahrernameInput.value.trim() !== '') {
                    populateArchiveDropdown();
                 }
             });
             
             // Setze das Datum im manuellen Eingabeblock auf heute, wenn leer
             if (!manualDateInput.value) {
                 const today = new Date();
                 const todayStr = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}-${String(today.getDate()).padStart(2, '0')}`;
                 manualDateInput.value = todayStr;
             }

             populateArchiveDropdown();
             renderShiftSummary();
             
             const isSummaryAllowed = isPreviousMonthCompleted();
             const previousMonthInfo = getPreviousMonthKeyInfo(getCurrentDate()); 
             
             btnMonthSummary.disabled = !isSummaryAllowed; 
             
             const today = getCurrentDate(); 
             const currentMonth = today.toLocaleDateString('de-DE', { month: 'long' });
             
             if (isSummaryAllowed) {
                btnMonthSummary.textContent = `Monatsabrechnung ${previousMonthInfo.monthName} erstellen (PDF)`;
                summaryInfo.textContent = `Abrechnung f√ºr ${previousMonthInfo.monthName} ist erlaubt.`;
                summaryInfo.className = 'text-sm text-green-400 text-center mt-2 font-semibold';
             } else {
                btnMonthSummary.textContent = `Monatsabrechnung ${previousMonthInfo.monthName} erstellen (PDF)`;
                btnMonthSummary.disabled = true;
                summaryInfo.textContent = `Abrechnung erst ab dem 1. des Monats m√∂glich. (Aktuelles Datum: ${today.getDate()}. ${currentMonth})`;
                summaryInfo.className = 'text-sm text-red-400 text-center mt-2 font-semibold';
             }
             
             if (state.isWorking && !state.isPaused) {
                 startTimer();
             } else {
                 updateUI();
             }
        }
        
        document.addEventListener('DOMContentLoaded', () => {
             initializeStatus();
        });
        
    </script>
</body>
</html>
